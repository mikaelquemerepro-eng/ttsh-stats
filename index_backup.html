<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>R√©sultats Tennis de Table - ST HERBLAIN T.T</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            overflow: hidden;
        }
        
        header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }
        
        header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
        }
        
        header p {
            font-size: 1.2em;
            opacity: 0.9;
        }
        
        .nav-tabs {
            display: flex;
            background: #f5f5f5;
            border-bottom: 2px solid #ddd;
        }
        
        .nav-tab {
            flex: 1;
            padding: 20px;
            text-align: center;
            cursor: pointer;
            background: #f5f5f5;
            border: none;
            font-size: 1.1em;
            font-weight: bold;
            transition: all 0.3s;
        }
        
        .nav-tab:hover {
            background: #e0e0e0;
        }
        
        .nav-tab.active {
            background: white;
            color: #667eea;
            border-bottom: 3px solid #667eea;
        }
        
        .content {
            padding: 30px;
        }
        
        .content-with-sidebar {
            display: flex;
            gap: 0;
            padding: 0;
        }
        
        .sidebar-tabs {
            width: 200px;
            background: #f5f5f5;
            border-right: 2px solid #ddd;
            min-height: 600px;
        }
        
        .sidebar-tab {
            width: 100%;
            padding: 15px 20px;
            text-align: left;
            cursor: pointer;
            background: #f5f5f5;
            border: none;
            border-bottom: 1px solid #e0e0e0;
            font-size: 1em;
            font-weight: 500;
            transition: all 0.3s;
            display: block;
        }
        
        .sidebar-tab:hover {
            background: #e0e0e0;
        }
        
        .sidebar-tab.active {
            background: white;
            color: #667eea;
            border-left: 4px solid #667eea;
            font-weight: bold;
        }
        
        .main-section {
            display: none;
        }
        
        .main-section.active {
            display: block;
            width: 100%;
        }
        
        .sub-content {
            flex: 1;
            padding: 30px;
        }
        
        .journee-section {
            display: none;
        }
        
        .journee-section.active {
            display: block;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .stat-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
        }
        
        .stat-card .number {
            font-size: 2.5em;
            font-weight: bold;
            margin-bottom: 10px;
        }
        
        .stat-card .label {
            font-size: 1em;
            opacity: 0.9;
        }
        
        .matches-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
            gap: 20px;
        }
        
        .match-card {
            background: white;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            padding: 20px;
            transition: all 0.3s;
            cursor: pointer;
        }
        
        .match-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 25px rgba(0,0,0,0.1);
            border-color: #667eea;
        }
        
        .match-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 15px;
            border-bottom: 2px solid #f0f0f0;
        }
        
        .match-equipe {
            background: #667eea;
            color: white;
            padding: 4px 12px;
            border-radius: 5px;
            font-weight: bold;
            font-size: 0.9em;
            margin-right: 10px;
        }
        
        .match-teams {
            font-size: 1.1em;
            font-weight: bold;
            color: #333;
            flex: 1;
        }
        
        .match-score {
            font-size: 1.8em;
            font-weight: bold;
            color: #667eea;
            white-space: nowrap;
            margin-left: 15px;
        }
        
        .match-info {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            font-size: 0.9em;
            color: #666;
        }
        
        .match-info div {
            display: flex;
            align-items: center;
        }
        
        .match-info .icon {
            margin-right: 8px;
            font-size: 1.2em;
        }
        
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
            overflow-y: auto;
        }
        
        .modal.active {
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .modal-content {
            background-color: white;
            margin: 20px;
            padding: 0;
            border-radius: 15px;
            width: 90%;
            max-width: 900px;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        }
        
        .modal-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 25px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .modal-header h2 {
            font-size: 1.8em;
        }
        
        .close {
            color: white;
            font-size: 2em;
            font-weight: bold;
            cursor: pointer;
            background: none;
            border: none;
            padding: 0;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            transition: background 0.3s;
        }
        
        .close:hover {
            background: rgba(255,255,255,0.2);
        }
        
        .modal-body {
            padding: 30px;
        }
        
        .teams-section {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
            margin-bottom: 30px;
        }
        
        .team-panel {
            background: #f9f9f9;
            padding: 20px;
            border-radius: 10px;
        }
        
        .team-panel h3 {
            color: #667eea;
            margin-bottom: 15px;
            font-size: 1.3em;
        }
        
        .player-list {
            list-style: none;
        }
        
        .player-item {
            padding: 10px;
            margin-bottom: 8px;
            background: white;
            border-radius: 5px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .player-name {
            font-weight: 500;
        }
        
        .player-license {
            color: #666;
            font-size: 0.9em;
            margin-left: 10px;
        }
        
        .player-points {
            background: #667eea;
            color: white;
            padding: 4px 12px;
            border-radius: 20px;
            font-weight: bold;
            font-size: 0.9em;
        }
        
        .rencontres-section {
            margin-top: 30px;
        }
        
        .rencontres-section h3 {
            color: #667eea;
            margin-bottom: 20px;
            font-size: 1.3em;
        }
        
        .rencontre-grid {
            display: grid;
            gap: 10px;
        }
        
        .rencontre-item {
            background: #f9f9f9;
            padding: 15px;
            border-radius: 8px;
            display: grid;
            grid-template-columns: 40px 1fr auto;
            gap: 15px;
            align-items: center;
        }
        
        .rencontre-item.victoire {
            background: #e8f5e9;
            border-left: 4px solid #4CAF50;
        }
        
        .rencontre-item.defaite {
            background: #ffebee;
            border-left: 4px solid #f44336;
        }
        
        .rencontre-num {
            background: #667eea;
            color: white;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
        }
        
        .rencontre-players {
            font-size: 0.95em;
        }
        
        .rencontre-players .vs {
            color: #999;
            margin: 0 10px;
        }
        
        .rencontre-sets {
            display: flex;
            gap: 8px;
            align-items: center;
        }
        
        .set-score {
            background: white;
            padding: 5px 10px;
            border-radius: 5px;
            font-weight: bold;
            font-size: 0.9em;
            min-width: 50px;
            text-align: center;
            border: 2px solid #ddd;
        }
        
        .set-score.herblain-win {
            background: #e8f5e9;
            color: #2e7d32;
            border-color: #4CAF50;
        }
        
        .set-score.herblain-lose {
            background: #ffebee;
            color: #c62828;
            border-color: #f44336;
        }
        
        .rencontre-result {
            font-weight: bold;
            font-size: 1.1em;
            color: #667eea;
            margin-left: 10px;
        }
        
        .stats-table {
            width: 100%;
            border-collapse: collapse;
            background: white;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .stats-table thead {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        
        .stats-table th {
            padding: 15px;
            text-align: left;
            font-weight: 600;
            cursor: pointer;
            user-select: none;
            position: relative;
        }
        
        .stats-table th:hover {
            background: rgba(255,255,255,0.1);
        }
        
        .stats-table th::after {
            content: ' ‚áÖ';
            opacity: 0.3;
            font-size: 0.8em;
        }
        
        .stats-table th.sort-asc::after {
            content: ' ‚ñ≤';
            opacity: 1;
        }
        
        .stats-table th.sort-desc::after {
            content: ' ‚ñº';
            opacity: 1;
        }
        
        .stats-table td {
            padding: 12px 15px;
            border-bottom: 1px solid #f0f0f0;
        }
        
        .stats-table tbody tr:hover {
            background: #f9f9f9;
        }
        
        .stats-table tbody tr:last-child td {
            border-bottom: none;
        }
        
        .rank {
            font-weight: bold;
            color: #667eea;
            font-size: 1.1em;
        }
        
        .player-name-cell {
            font-weight: 500;
        }
        
        .stats-badge {
            display: inline-block;
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 0.85em;
            font-weight: bold;
        }
        
        .badge-success {
            background: #e8f5e9;
            color: #2e7d32;
        }
        
        .badge-info {
            background: #e3f2fd;
            color: #1565c0;
        }
        
        .badge-warning {
            background: #fff3e0;
            color: #e65100;
        }
        
        .win-rate-bar {
            background: #f0f0f0;
            border-radius: 10px;
            height: 20px;
            position: relative;
            overflow: hidden;
        }
        
        .win-rate-fill {
            background: linear-gradient(90deg, #4CAF50 0%, #2e7d32 100%);
            height: 100%;
            border-radius: 10px;
            transition: width 0.3s;
        }
        
        .win-rate-text {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 0.75em;
            font-weight: bold;
            color: #333;
        }
        
        .section-title {
            font-size: 1.8em;
            color: #667eea;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 3px solid #667eea;
        }
        
        .chart-container {
            background: white;
            padding: 25px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin: 30px 0;
        }
        
        .chart-container h3 {
            color: #667eea;
            margin-bottom: 20px;
        }
        
        .chart-layout {
            display: flex;
            gap: 30px;
            align-items: center;
        }
        
        .chart-ratio {
            min-width: 200px;
            text-align: center;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 10px;
            color: white;
        }
        
        .chart-ratio .ratio-label {
            font-size: 0.9em;
            opacity: 0.9;
            margin-bottom: 10px;
        }
        
        .chart-ratio .ratio-value {
            font-size: 3em;
            font-weight: bold;
            margin: 10px 0;
        }
        
        .chart-ratio .ratio-details {
            display: flex;
            justify-content: space-around;
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px solid rgba(255,255,255,0.3);
        }
        
        .chart-ratio .ratio-item {
            text-align: center;
        }
        
        .chart-ratio .ratio-item-value {
            font-size: 1.8em;
            font-weight: bold;
        }
        
        .chart-ratio .ratio-item-label {
            font-size: 0.85em;
            opacity: 0.9;
        }
        
        @media (max-width: 768px) {
            .teams-section {
                grid-template-columns: 1fr;
            }
            
            .matches-grid {
                grid-template-columns: 1fr;
            }
            
            .chart-layout {
                flex-direction: column;
            }
            
            .chart-ratio {
                width: 100%;
            }
            
            .match-header {
                flex-direction: column;
                align-items: flex-start;
            }
            
            .match-score {
                margin-left: 0;
                margin-top: 10px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>üèì ST HERBLAIN T.T</h1>
            <p>R√©sultats des matchs de tennis de table</p>
        </header>
        
        <div class="nav-tabs">
            <button class="nav-tab active" onclick="showMainSection('journees', this)">
                üìÖ Journ√©es
            </button>
            <button class="nav-tab" onclick="showMainSection('stats-joueurs', this)">
                üë• Stats Joueurs
            </button>
            <button class="nav-tab" onclick="showMainSection('stats-club', this)">
                üèÜ Stats Club
            </button>
        </div>
        
        <div class="content">
            <!-- Section Journ√©es avec sidebar -->
            <div id="journees" class="main-section active">
                <div class="content-with-sidebar">
                    <div class="sidebar-tabs">
                        <button class="sidebar-tab active" onclick="showJournee('J3_20251012', this)">
                            J3 - 12/10/2025
                        </button>
                        <button class="sidebar-tab" onclick="showJournee('J4_20251116', this)">
                            J4 - 16/11/2025
                        </button>
                    </div>
                    <div class="sub-content">
                        <div id="J3_20251012" class="journee-section active">
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="number" id="stats-j3-matches">-</div>
                        <div class="label">Matchs</div>
                    </div>
                    <div class="stat-card">
                        <div class="number" id="stats-j3-victoires">-</div>
                        <div class="label">Victoires</div>
                    </div>
                    <div class="stat-card">
                        <div class="number" id="stats-j3-nuls">-</div>
                        <div class="label">Nuls</div>
                    </div>
                    <div class="stat-card">
                        <div class="number" id="stats-j3-defaites">-</div>
                        <div class="label">D√©faites</div>
                    </div>
                </div>
                <div id="matches-j3" class="matches-grid"></div>
                <div class="chart-container">
                    <h3>üìä Taux de r√©ussite par nombre de sets jou√©s</h3>
                    <div class="chart-layout">
                        <div class="chart-ratio" id="ratio-j3">
                            <div class="ratio-label">Ratio global</div>
                            <div class="ratio-value">-</div>
                            <div class="ratio-details">
                                <div class="ratio-item">
                                    <div class="ratio-item-value" id="wins-j3">-</div>
                                    <div class="ratio-item-label">Victoires</div>
                                </div>
                                <div class="ratio-item">
                                    <div class="ratio-item-value" id="losses-j3">-</div>
                                    <div class="ratio-item-label">D√©faites</div>
                                </div>
                            </div>
                        </div>
                        <div class="chart-wrapper" style="flex: 1;">
                            <canvas id="chart-j3"></canvas>
                        </div>
                    </div>
                </div>
            </div>
            
            <div id="J4_20251116" class="journee-section">
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="number" id="stats-j4-matches">-</div>
                        <div class="label">Matchs</div>
                    </div>
                    <div class="stat-card">
                        <div class="number" id="stats-j4-victoires">-</div>
                        <div class="label">Victoires</div>
                    </div>
                    <div class="stat-card">
                        <div class="number" id="stats-j4-nuls">-</div>
                        <div class="label">Nuls</div>
                    </div>
                    <div class="stat-card">
                        <div class="number" id="stats-j4-defaites">-</div>
                        <div class="label">D√©faites</div>
                    </div>
                </div>
                <div id="matches-j4" class="matches-grid"></div>
                <div class="chart-container">
                    <h3>üìä Taux de r√©ussite par nombre de sets jou√©s</h3>
                    <div class="chart-layout">
                        <div class="chart-ratio" id="ratio-j4">
                            <div class="ratio-label">Ratio global</div>
                            <div class="ratio-value">-</div>
                            <div class="ratio-details">
                                <div class="ratio-item">
                                    <div class="ratio-item-value" id="wins-j4">-</div>
                                    <div class="ratio-item-label">Victoires</div>
                                </div>
                                <div class="ratio-item">
                                    <div class="ratio-item-value" id="losses-j4">-</div>
                                    <div class="ratio-item-label">D√©faites</div>
                                </div>
                            </div>
                        </div>
                        <div class="chart-wrapper" style="flex: 1;">
                            <canvas id="chart-j4"></canvas>
                        </div>
                    </div>
                </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Section Stats Joueurs -->
            <div id="stats-joueurs" class="main-section">
                <h2 class="section-title">üë• Statistiques des joueurs ST HERBLAIN T.T</h2>
                <div id="stats-content">
                    <p style="text-align: center; color: #999; padding: 40px;">Chargement des statistiques...</p>
                </div>
            </div>
            
            <!-- Section Stats Club -->
            <div id="stats-club" class="main-section">
                <h2 class="section-title">üèÜ Statistiques du club ST HERBLAIN T.T</h2>
                <div id="stats-club-content">
                    <p style="text-align: center; color: #999; padding: 40px;">Chargement des statistiques...</p>
                </div>
            </div>
        </div>
    </div>
    
    <div id="matchModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="modal-title">D√©tails du match</h2>
                <button class="close" onclick="closeModal()">&times;</button>
            </div>
            <div class="modal-body" id="modal-body">
                <!-- Contenu dynamique -->
            </div>
        </div>
    </div>
    
    <script>
        console.log('Script charg√© - v2');
        let allData = {};
        
        async function loadData() {
            try {
                console.log('Chargement des donn√©es...');
                const j3Response = await fetch('J3_20251012/tous_les_matchs.json');
                const j4Response = await fetch('J4_20251116/tous_les_matchs.json');
                const statsResponse = await fetch('statistiques.json');
                
                allData['J3_20251012'] = await j3Response.json();
                allData['J4_20251116'] = await j4Response.json();
                allData['statistiques'] = await statsResponse.json();
                
                console.log('Donn√©es J3:', allData['J3_20251012'].length, 'matchs');
                console.log('Donn√©es J4:', allData['J4_20251116'].length, 'matchs');
                console.log('Statistiques:', Object.keys(allData['statistiques'].joueurs).length, 'joueurs');
                
                displayMatches('J3_20251012');
                displayMatches('J4_20251116');
                displayStatistics();
                displayClubStatistics();
                createGlobalSetDistributionChart();
            } catch (error) {
                console.error('Erreur de chargement des donn√©es:', error);
                alert('Erreur: ' + error.message);
            }
        }
        
        function showMainSection(sectionId, element) {
            // Update main tabs
            document.querySelectorAll('.nav-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            if (element) {
                element.classList.add('active');
            }
            
            // Update main sections
            document.querySelectorAll('.main-section').forEach(section => {
                section.classList.remove('active');
            });
            document.getElementById(sectionId).classList.add('active');
        }
        
        function showJournee(journeeId, element) {
            // Update sidebar tabs
            document.querySelectorAll('.sidebar-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            if (element) {
                element.classList.add('active');
            }
            
            // Update journee sections
            document.querySelectorAll('.journee-section').forEach(section => {
                section.classList.remove('active');
            });
            document.getElementById(journeeId).classList.add('active');
        }
        
        function displayStatistics() {
            if (!allData['statistiques']) {
                console.error('Pas de statistiques disponibles');
                return;
            }
            
            const stats = allData['statistiques'];
            const joueurs = stats.joueurs;
            
            // Convertir en tableau et trier par taux de victoire
            let joueursArray = Object.entries(joueurs).map(([nom, data]) => ({
                nom: nom,
                ...data
            }));
            
            // Filtrer les joueurs avec au moins 3 matches
            joueursArray = joueursArray.filter(j => j.matches.total >= 3);
            
            // Trier par taux de victoire puis victoires
            joueursArray.sort((a, b) => {
                if (b.matches.taux_victoire !== a.matches.taux_victoire) {
                    return b.matches.taux_victoire - a.matches.taux_victoire;
                }
                return b.matches.victoires - a.matches.victoires;
            });
            
            const container = document.getElementById('stats-content');
            
            let html = `
                <h3 style="color: #667eea; margin-bottom: 20px;">üèÜ Classement des joueurs (minimum 3 matches)</h3>
                <table class="stats-table" id="stats-table">
                    <thead>
                        <tr>
                            <th data-column="rank" data-type="number">#</th>
                            <th data-column="nom" data-type="string">Joueur</th>
                            <th data-column="points_officiels" data-type="number">Points</th>
                            <th data-column="matches.total" data-type="number">Matches</th>
                            <th data-column="matches.victoires" data-type="number">Victoires</th>
                            <th data-column="matches.defaites" data-type="number">D√©faites</th>
                            <th data-column="matches.taux_victoire" data-type="number">Taux de victoire</th>
                            <th data-column="sets.total" data-type="number">Sets</th>
                            <th data-column="sets.ratio" data-type="number">Ratio sets</th>
                            <th data-column="performance_classement.score" data-type="number" title="Points gagn√©s contre mieux class√©s - Points perdus contre moins bien class√©s">Perf. Classement</th>
                        </tr>
                    </thead>
                    <tbody id="stats-table-body">
            `;
            
            joueursArray.forEach((joueur, index) => {
                const winRate = joueur.matches.taux_victoire;
                const totalSets = joueur.sets.gagnes + joueur.sets.perdus;
                const perfScore = joueur.performance_classement?.score || 0;
                const perfClass = perfScore > 0 ? 'badge-success' : perfScore < 0 ? 'badge-warning' : 'badge-info';
                const perfSign = perfScore > 0 ? '+' : '';
                
                html += `
                    <tr>
                        <td class="rank">${index + 1}</td>
                        <td class="player-name-cell">${joueur.nom}</td>
                        <td><span class="stats-badge badge-info">${joueur.points_officiels} pts</span></td>
                        <td>${joueur.matches.total}</td>
                        <td><span class="stats-badge badge-success">${joueur.matches.victoires}</span></td>
                        <td><span class="stats-badge badge-warning">${joueur.matches.defaites}</span></td>
                        <td>
                            <div class="win-rate-bar">
                                <div class="win-rate-fill" style="width: ${winRate}%"></div>
                                <div class="win-rate-text">${winRate}%</div>
                            </div>
                        </td>
                        <td>${joueur.sets.gagnes} - ${joueur.sets.perdus}</td>
                        <td>${(joueur.sets.ratio * 100).toFixed(0)}%</td>
                        <td><span class="stats-badge ${perfClass}">${perfSign}${perfScore}</span></td>
                    </tr>
                `;
            });
            
            html += `
                    </tbody>
                </table>
            `;
            
            container.innerHTML = html;
            
            // Ajouter les √©v√©nements de tri
            initSortableTable(joueursArray);
        }
        
        function displayClubStatistics() {
            if (!allData['statistiques']) {
                console.error('Pas de statistiques disponibles');
                return;
            }
            
            const stats = allData['statistiques'];
            const joueurs = stats.joueurs;
            
            const container = document.getElementById('stats-club-content');
            
            let html = `
                <div style="margin-bottom: 30px;">
                    <div class="stats-grid" style="grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));">
                        <div class="stat-card">
                            <div class="number">${Object.keys(joueurs).length}</div>
                            <div class="label">Joueurs</div>
                        </div>
                        <div class="stat-card">
                            <div class="number">${stats.totaux.nombre_matches}</div>
                            <div class="label">Matchs d'√©quipe</div>
                        </div>
                        <div class="stat-card">
                            <div class="number">${stats.totaux.nombre_rencontres}</div>
                            <div class="label">Rencontres</div>
                        </div>
                        <div class="stat-card">
                            <div class="number">${stats.totaux.nombre_journees}</div>
                            <div class="label">Journ√©es</div>
                        </div>
                    </div>
                </div>
                
                <div class="chart-container" style="margin-top: 30px;">
                    <h3>üìä Taux de r√©ussite par nombre de sets jou√©s (toutes journ√©es)</h3>
                    <div class="chart-layout">
                        <div class="chart-ratio" id="ratio-global">
                            <div class="ratio-label">Ratio global</div>
                            <div class="ratio-value">-</div>
                            <div class="ratio-details">
                                <div class="ratio-item">
                                    <div class="ratio-item-value" id="wins-global">-</div>
                                    <div class="ratio-item-label">Victoires</div>
                                </div>
                                <div class="ratio-item">
                                    <div class="ratio-item-value" id="losses-global">-</div>
                                    <div class="ratio-item-label">D√©faites</div>
                                </div>
                            </div>
                        </div>
                        <div class="chart-wrapper" style="flex: 1;">
                            <canvas id="chart-stats-global"></canvas>
                        </div>
                    </div>
                </div>
            `;
            
            container.innerHTML = html;
        }
        
        // Fonction de tri du tableau
        function initSortableTable(joueursData) {
            const table = document.getElementById('stats-table');
            if (!table) return;
            
            const headers = table.querySelectorAll('th');
            let currentSort = { column: 'matches.taux_victoire', direction: 'desc' };
            let sortedData = [...joueursData];
            
            // Marquer la colonne par d√©faut
            headers.forEach(th => {
                if (th.getAttribute('data-column') === currentSort.column) {
                    th.classList.add('sort-desc');
                }
            });
            
            headers.forEach((header, index) => {
                const column = header.getAttribute('data-column');
                const type = header.getAttribute('data-type');
                
                if (!column) return;
                
                header.addEventListener('click', () => {
                    // D√©terminer la direction du tri
                    let direction = 'asc';
                    if (currentSort.column === column) {
                        direction = currentSort.direction === 'asc' ? 'desc' : 'asc';
                    }
                    
                    // Mettre √† jour les classes CSS
                    headers.forEach(th => {
                        th.classList.remove('sort-asc', 'sort-desc');
                    });
                    header.classList.add(direction === 'asc' ? 'sort-asc' : 'sort-desc');
                    
                    // Fonction pour obtenir la valeur d'une propri√©t√© imbriqu√©e
                    const getValue = (obj, path) => {
                        if (path === 'rank') return joueursData.indexOf(obj) + 1;
                        if (path === 'sets.total') return obj.sets.gagnes + obj.sets.perdus;
                        return path.split('.').reduce((o, p) => o?.[p], obj);
                    };
                    
                    // Trier les donn√©es
                    sortedData.sort((a, b) => {
                        let valA = getValue(a, column);
                        let valB = getValue(b, column);
                        
                        // G√©rer les valeurs nulles/undefined
                        if (valA == null) valA = type === 'number' ? -Infinity : '';
                        if (valB == null) valB = type === 'number' ? -Infinity : '';
                        
                        let comparison = 0;
                        if (type === 'number') {
                            comparison = valA - valB;
                        } else {
                            comparison = valA.toString().localeCompare(valB.toString());
                        }
                        
                        return direction === 'asc' ? comparison : -comparison;
                    });
                    
                    currentSort = { column, direction };
                    
                    // R√©afficher le tableau
                    updateTableRows(sortedData);
                });
            });
        }
        
        function createGlobalSetDistributionChart() {
            // Combiner tous les matchs de toutes les journ√©es
            const allMatches = [];
            
            if (allData['J3_20251012']) {
                allMatches.push(...allData['J3_20251012']);
            }
            if (allData['J4_20251116']) {
                allMatches.push(...allData['J4_20251116']);
            }
            
            if (allMatches.length === 0) return;
            
            // Compter les victoires et d√©faites par nombre de sets jou√©s
            const stats = {
                sets3: { wins: 0, losses: 0 },
                sets4: { wins: 0, losses: 0 },
                sets5: { wins: 0, losses: 0 }
            };
            
            allMatches.forEach(match => {
                const equipeA = match.equipes.equipe_a;
                const equipeX = match.equipes.equipe_x;
                const isHerblainA = equipeA.nom && equipeA.nom.includes('HERBLAIN');
                const isHerblainX = equipeX.nom && equipeX.nom.includes('HERBLAIN');
                
                match.rencontres.forEach(r => {
                    let setsWonA = 0;
                    let setsWonX = 0;
                    if (r.sets && Array.isArray(r.sets)) {
                        r.sets.forEach(s => {
                            const scoreA = s.equipe_a || s.score_a || 0;
                            const scoreX = s.equipe_x || s.score_x || 0;
                            if (scoreA > scoreX) setsWonA++;
                            else if (scoreX > scoreA) setsWonX++;
                        });
                    }
                    
                    const totalSets = setsWonA + setsWonX;
                    let herblainWon = false;
                    
                    if (isHerblainA) {
                        herblainWon = setsWonA > setsWonX;
                    } else if (isHerblainX) {
                        herblainWon = setsWonX > setsWonA;
                    } else {
                        return;
                    }
                    
                    if (totalSets === 3) {
                        if (herblainWon) stats.sets3.wins++;
                        else stats.sets3.losses++;
                    } else if (totalSets === 4) {
                        if (herblainWon) stats.sets4.wins++;
                        else stats.sets4.losses++;
                    } else if (totalSets === 5) {
                        if (herblainWon) stats.sets5.wins++;
                        else stats.sets5.losses++;
                    }
                });
            });
            
            const calcPercentage = (wins, losses) => {
                const total = wins + losses;
                return total > 0 ? ((wins / total) * 100).toFixed(1) : 0;
            };
            
            // Mettre √† jour le ratio global
            const totalWins = stats.sets3.wins + stats.sets4.wins + stats.sets5.wins;
            const totalLosses = stats.sets3.losses + stats.sets4.losses + stats.sets5.losses;
            const totalMatches = totalWins + totalLosses;
            const winPercentage = totalMatches > 0 ? ((totalWins / totalMatches) * 100).toFixed(0) : 0;
            
            document.getElementById('wins-global').textContent = totalWins;
            document.getElementById('losses-global').textContent = totalLosses;
            document.getElementById('ratio-global').querySelector('.ratio-value').textContent = `${winPercentage}%`;
            
            const canvas = document.getElementById('chart-stats-global');
            if (!canvas) return;
            
            if (window.chart_stats_global) {
                window.chart_stats_global.destroy();
            }
            
            window.chart_stats_global = new Chart(canvas, {
                type: 'bar',
                data: {
                    labels: ['3 sets', '4 sets', '5 sets'],
                    datasets: [
                        {
                            label: 'Victoires',
                            data: [stats.sets3.wins, stats.sets4.wins, stats.sets5.wins],
                            backgroundColor: '#4CAF50',
                            borderColor: '#2e7d32',
                            borderWidth: 2
                        },
                        {
                            label: 'D√©faites',
                            data: [stats.sets3.losses, stats.sets4.losses, stats.sets5.losses],
                            backgroundColor: '#f44336',
                            borderColor: '#c62828',
                            borderWidth: 2
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    scales: {
                        x: {
                            stacked: false,
                            grid: {
                                display: false
                            },
                            ticks: {
                                font: {
                                    size: 14,
                                    weight: 'bold'
                                }
                            }
                        },
                        y: {
                            beginAtZero: true,
                            ticks: {
                                stepSize: 5,
                                font: {
                                    size: 12
                                }
                            },
                            grid: {
                                color: 'rgba(0, 0, 0, 0.05)'
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            position: 'top',
                            labels: {
                                padding: 20,
                                font: {
                                    size: 14,
                                    weight: 'bold'
                                },
                                usePointStyle: true,
                                pointStyle: 'rectRounded'
                            }
                        },
                        tooltip: {
                            callbacks: {
                                afterLabel: function(context) {
                                    const dataIndex = context.dataIndex;
                                    let wins, losses, percentage;
                                    
                                    if (dataIndex === 0) {
                                        wins = stats.sets3.wins;
                                        losses = stats.sets3.losses;
                                    } else if (dataIndex === 1) {
                                        wins = stats.sets4.wins;
                                        losses = stats.sets4.losses;
                                    } else {
                                        wins = stats.sets5.wins;
                                        losses = stats.sets5.losses;
                                    }
                                    
                                    percentage = calcPercentage(wins, losses);
                                    const total = wins + losses;
                                    
                                    return [
                                        `Total: ${total} matchs`,
                                        `Taux de victoire: ${percentage}%`
                                    ];
                                }
                            }
                        }
                    }
                }
            });
        }
        
        function updateTableRows(joueursArray) {
            const tbody = document.getElementById('stats-table-body');
            if (!tbody) return;
            
            let html = '';
            joueursArray.forEach((joueur, index) => {
                const winRate = joueur.matches.taux_victoire;
                const totalSets = joueur.sets.gagnes + joueur.sets.perdus;
                const perfScore = joueur.performance_classement?.score || 0;
                const perfClass = perfScore > 0 ? 'badge-success' : perfScore < 0 ? 'badge-warning' : 'badge-info';
                const perfSign = perfScore > 0 ? '+' : '';
                
                html += `
                    <tr>
                        <td class="rank">${index + 1}</td>
                        <td class="player-name-cell">${joueur.nom}</td>
                        <td><span class="stats-badge badge-info">${joueur.points_officiels} pts</span></td>
                        <td>${joueur.matches.total}</td>
                        <td><span class="stats-badge badge-success">${joueur.matches.victoires}</span></td>
                        <td><span class="stats-badge badge-warning">${joueur.matches.defaites}</span></td>
                        <td>
                            <div class="win-rate-bar">
                                <div class="win-rate-fill" style="width: ${winRate}%"></div>
                                <div class="win-rate-text">${winRate}%</div>
                            </div>
                        </td>
                        <td>${joueur.sets.gagnes} - ${joueur.sets.perdus}</td>
                        <td>${(joueur.sets.ratio * 100).toFixed(0)}%</td>
                        <td><span class="stats-badge ${perfClass}">${perfSign}${perfScore}</span></td>
                    </tr>
                `;
            });
            
            tbody.innerHTML = html;
        }
        
        function displayMatches(journeeId) {
            const matches = allData[journeeId];
            if (!matches) {
                console.error('Pas de donn√©es pour', journeeId);
                return;
            }
            
            const journeePrefix = journeeId.split('_')[0].toLowerCase();
            const matchesContainer = document.getElementById(`matches-${journeePrefix}`);
            
            if (!matchesContainer) {
                console.error('Container non trouv√©:', `matches-${journeePrefix}`);
                return;
            }
            
            console.log(`Affichage de ${matches.length} matchs pour ${journeeId}`);
            matchesContainer.innerHTML = ''; // Clear existing content
            
            // Trier par num√©ro d'√©quipe TTSH
            const sortedMatches = matches.slice().sort((a, b) => {
                const numA = parseInt((a.equipe_ttsh || '').replace('TTSH', '')) || 999;
                const numB = parseInt((b.equipe_ttsh || '').replace('TTSH', '')) || 999;
                return numA - numB;
            });
            
            // Calculate stats
            let victoires = 0, defaites = 0, nuls = 0;
            
            sortedMatches.forEach((match, index) => {
                const equipeA = match.equipes.equipe_a;
                const equipeX = match.equipes.equipe_x;
                const scoreA = match.resultat_global.equipe_a;
                const scoreX = match.resultat_global.equipe_x;
                
                // Determine if ST HERBLAIN won
                const isHerblainA = equipeA.nom && equipeA.nom.includes('HERBLAIN');
                const isHerblainX = equipeX.nom && equipeX.nom.includes('HERBLAIN');
                
                if (isHerblainA) {
                    if (scoreA > scoreX) victoires++;
                    else if (scoreA < scoreX) defaites++;
                    else nuls++;
                } else if (isHerblainX) {
                    if (scoreX > scoreA) victoires++;
                    else if (scoreX < scoreA) defaites++;
                    else nuls++;
                }
                
                const card = document.createElement('div');
                card.className = 'match-card';
                card.onclick = () => showMatchDetail(journeeId, matches.indexOf(match));
                
                const teamA = equipeA.nom || '√âquipe A';
                const teamX = equipeX.nom || '√âquipe X';
                const nbRencontres = match.rencontres.length;
                const expectedMatches = match.expected_matches || 20;
                const equipeTTSH = match.equipe_ttsh || '';
                
                // Calculer le nombre total de sets remport√©s par chaque √©quipe
                let totalSetsA = 0;
                let totalSetsX = 0;
                match.rencontres.forEach(r => {
                    if (r.sets && Array.isArray(r.sets)) {
                        r.sets.forEach(s => {
                            const setScoreA = s.equipe_a || s.score_a || 0;
                            const setScoreX = s.equipe_x || s.score_x || 0;
                            if (setScoreA > setScoreX) totalSetsA++;
                            else if (setScoreX > setScoreA) totalSetsX++;
                        });
                    }
                });
                
                card.innerHTML = `
                    <div class="match-header">
                        <div style="display: flex; align-items: center; flex: 1;">
                            ${equipeTTSH ? `<span class="match-equipe">${equipeTTSH}</span>` : ''}
                            <div class="match-teams">${teamA} vs ${teamX}</div>
                        </div>
                        <div class="match-score">${scoreA} - ${scoreX}</div>
                    </div>
                    <div class="match-info">
                        <div>
                            <span class="icon">üë•</span>
                            ${equipeA.joueurs.length} vs ${equipeX.joueurs.length} joueurs
                        </div>
                        <div>
                            <span class="icon">üéØ</span>
                            ${nbRencontres}/${expectedMatches} rencontres
                        </div>
                        <div>
                            <span class="icon">üèì</span>
                            ${totalSetsA} - ${totalSetsX} sets
                        </div>
                    </div>
                `;
                
                matchesContainer.appendChild(card);
            });
            
            // Update stats
            document.getElementById(`stats-${journeePrefix}-matches`).textContent = sortedMatches.length;
            document.getElementById(`stats-${journeePrefix}-victoires`).textContent = victoires;
            document.getElementById(`stats-${journeePrefix}-nuls`).textContent = nuls;
            document.getElementById(`stats-${journeePrefix}-defaites`).textContent = defaites;
            
            // Create pie chart for this journee
            createSetDistributionChart(journeeId, sortedMatches);
        }
        
        function createSetDistributionChart(journeeId, matches) {
            const journeePrefix = journeeId.split('_')[0].toLowerCase();
            const canvasId = `chart-${journeePrefix}`;
            
            // Compter les victoires et d√©faites par nombre de sets jou√©s
            const stats = {
                sets3: { wins: 0, losses: 0 },  // Matchs en 3 sets (3-0 ou 0-3)
                sets4: { wins: 0, losses: 0 },  // Matchs en 4 sets (3-1 ou 1-3)
                sets5: { wins: 0, losses: 0 }   // Matchs en 5 sets (3-2 ou 2-3)
            };
            
            matches.forEach(match => {
                const equipeA = match.equipes.equipe_a;
                const equipeX = match.equipes.equipe_x;
                const isHerblainA = equipeA.nom && equipeA.nom.includes('HERBLAIN');
                const isHerblainX = equipeX.nom && equipeX.nom.includes('HERBLAIN');
                
                match.rencontres.forEach(r => {
                    // Compter les sets gagn√©s
                    let setsWonA = 0;
                    let setsWonX = 0;
                    if (r.sets && Array.isArray(r.sets)) {
                        r.sets.forEach(s => {
                            const scoreA = s.equipe_a || s.score_a || 0;
                            const scoreX = s.equipe_x || s.score_x || 0;
                            if (scoreA > scoreX) setsWonA++;
                            else if (scoreX > scoreA) setsWonX++;
                        });
                    }
                    
                    const totalSets = setsWonA + setsWonX;
                    let herblainWon = false;
                    
                    // D√©terminer si ST HERBLAIN a gagn√©
                    if (isHerblainA) {
                        herblainWon = setsWonA > setsWonX;
                    } else if (isHerblainX) {
                        herblainWon = setsWonX > setsWonA;
                    } else {
                        return; // Ignorer si ST HERBLAIN ne joue pas
                    }
                    
                    // Classifier par nombre de sets
                    if (totalSets === 3) {
                        if (herblainWon) stats.sets3.wins++;
                        else stats.sets3.losses++;
                    } else if (totalSets === 4) {
                        if (herblainWon) stats.sets4.wins++;
                        else stats.sets4.losses++;
                    } else if (totalSets === 5) {
                        if (herblainWon) stats.sets5.wins++;
                        else stats.sets5.losses++;
                    }
                });
            });
            
            // Calculer les pourcentages
            const calcPercentage = (wins, losses) => {
                const total = wins + losses;
                return total > 0 ? ((wins / total) * 100).toFixed(1) : 0;
            };
            
            // Mettre √† jour le ratio global
            const totalWins = stats.sets3.wins + stats.sets4.wins + stats.sets5.wins;
            const totalLosses = stats.sets3.losses + stats.sets4.losses + stats.sets5.losses;
            const totalMatches = totalWins + totalLosses;
            const winPercentage = totalMatches > 0 ? ((totalWins / totalMatches) * 100).toFixed(0) : 0;
            
            document.getElementById(`wins-${journeePrefix}`).textContent = totalWins;
            document.getElementById(`losses-${journeePrefix}`).textContent = totalLosses;
            document.getElementById(`ratio-${journeePrefix}`).querySelector('.ratio-value').textContent = `${winPercentage}%`;
            
            const canvas = document.getElementById(canvasId);
            if (!canvas) return;
            
            // D√©truire l'ancien graphique s'il existe
            if (window[`chart_${journeePrefix}`]) {
                window[`chart_${journeePrefix}`].destroy();
            }
            
            // Cr√©er le nouveau graphique
            window[`chart_${journeePrefix}`] = new Chart(canvas, {
                type: 'bar',
                data: {
                    labels: ['3 sets', '4 sets', '5 sets'],
                    datasets: [
                        {
                            label: 'Victoires',
                            data: [stats.sets3.wins, stats.sets4.wins, stats.sets5.wins],
                            backgroundColor: '#4CAF50',
                            borderColor: '#2e7d32',
                            borderWidth: 2
                        },
                        {
                            label: 'D√©faites',
                            data: [stats.sets3.losses, stats.sets4.losses, stats.sets5.losses],
                            backgroundColor: '#f44336',
                            borderColor: '#c62828',
                            borderWidth: 2
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    scales: {
                        x: {
                            stacked: false,
                            grid: {
                                display: false
                            },
                            ticks: {
                                font: {
                                    size: 14,
                                    weight: 'bold'
                                }
                            }
                        },
                        y: {
                            beginAtZero: true,
                            ticks: {
                                stepSize: 1,
                                font: {
                                    size: 12
                                }
                            },
                            grid: {
                                color: 'rgba(0, 0, 0, 0.05)'
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            position: 'top',
                            labels: {
                                padding: 20,
                                font: {
                                    size: 14,
                                    weight: 'bold'
                                },
                                usePointStyle: true,
                                pointStyle: 'rectRounded'
                            }
                        },
                        tooltip: {
                            callbacks: {
                                afterLabel: function(context) {
                                    const dataIndex = context.dataIndex;
                                    let wins, losses, percentage;
                                    
                                    if (dataIndex === 0) {
                                        wins = stats.sets3.wins;
                                        losses = stats.sets3.losses;
                                    } else if (dataIndex === 1) {
                                        wins = stats.sets4.wins;
                                        losses = stats.sets4.losses;
                                    } else {
                                        wins = stats.sets5.wins;
                                        losses = stats.sets5.losses;
                                    }
                                    
                                    percentage = calcPercentage(wins, losses);
                                    const total = wins + losses;
                                    
                                    return [
                                        `Total: ${total} matchs`,
                                        `Taux de victoire: ${percentage}%`
                                    ];
                                }
                            }
                        }
                    }
                }
            });
        }
        
        function showMatchDetail(journeeId, matchIndex) {
            const match = allData[journeeId][matchIndex];
            const modal = document.getElementById('matchModal');
            const modalBody = document.getElementById('modal-body');
            
            const equipeA = match.equipes.equipe_a;
            const equipeX = match.equipes.equipe_x;
            const scoreA = match.resultat_global.equipe_a;
            const scoreX = match.resultat_global.equipe_x;
            const equipeTTSH = match.equipe_ttsh || '';
            
            document.getElementById('modal-title').innerHTML = 
                `${equipeTTSH ? `<span style="background: #667eea; color: white; padding: 5px 12px; border-radius: 5px; margin-right: 15px;">${equipeTTSH}</span>` : ''}${equipeA.nom || '√âquipe A'} ${scoreA} - ${scoreX} ${equipeX.nom || '√âquipe X'}`;
            
            // Build players lists
            const playersA = equipeA.joueurs.map(j => `
                <li class="player-item">
                    <div>
                        <span class="player-name">${j.nom} ${j.prenom}</span>
                        <span class="player-license">${j.licence}</span>
                    </div>
                    <span class="player-points">${j.points} pts</span>
                </li>
            `).join('');
            
            const playersX = equipeX.joueurs.map(j => `
                <li class="player-item">
                    <div>
                        <span class="player-name">${j.nom} ${j.prenom}</span>
                        <span class="player-license">${j.licence}</span>
                    </div>
                    <span class="player-points">${j.points} pts</span>
                </li>
            `).join('');
            
            // Build rencontres list
            const isHerblainA = equipeA.nom && equipeA.nom.includes('HERBLAIN');
            const isHerblainX = equipeX.nom && equipeX.nom.includes('HERBLAIN');
            
            const rencontres = match.rencontres.map(r => {
                console.log('Traitement rencontre:', r.numero, 'sets:', r.sets);
                // Handle joueur_a and joueur_x which can be objects or strings
                // For doubles, concatenate both players (only names for doubles)
                let joueurAName = '';
                if (typeof r.joueur_a === 'object' && r.joueur_a) {
                    if (r.joueur_a.joueur2) {
                        // Double: only last names
                        joueurAName = `${r.joueur_a.nom} / ${r.joueur_a.joueur2.nom}`;
                    } else {
                        // Simple: full name
                        joueurAName = `${r.joueur_a.nom} ${r.joueur_a.prenom}`;
                    }
                } else {
                    joueurAName = r.joueur_a || 'Joueur A';
                }
                
                let joueurXName = '';
                if (typeof r.joueur_x === 'object' && r.joueur_x) {
                    if (r.joueur_x.joueur2) {
                        // Double: only last names
                        joueurXName = `${r.joueur_x.nom} / ${r.joueur_x.joueur2.nom}`;
                    } else {
                        // Simple: full name
                        joueurXName = `${r.joueur_x.nom} ${r.joueur_x.prenom}`;
                    }
                } else {
                    joueurXName = r.joueur_x || 'Joueur X';
                }
                
                const isAbandon = (joueurAName && joueurAName.includes('(A)')) || (joueurXName && joueurXName.includes('(A)'));
                
                // Calculer le score en sets (nombre de sets gagn√©s par chaque joueur)
                let setsWonA = 0;
                let setsWonX = 0;
                r.sets.forEach(s => {
                    const scoreA = s.equipe_a || s.score_a || 0;
                    const scoreX = s.equipe_x || s.score_x || 0;
                    if (scoreA > scoreX) setsWonA++;
                    else if (scoreX > scoreA) setsWonX++;
                });
                
                const result = isAbandon ? '(A)' : `${setsWonA}-${setsWonX}`;
                
                // Score pour d√©terminer la victoire (1-0 ou 0-1)
                const matchScoreA = r.score_a !== undefined ? r.score_a : (r.score_match ? parseInt(r.score_match.split('-')[0]) : 0);
                const matchScoreX = r.score_x !== undefined ? r.score_x : (r.score_match ? parseInt(r.score_match.split('-')[1]) : 0);
                
                // Determine which player is from ST HERBLAIN
                const isJoueurAHerblain = isHerblainA;
                const isJoueurXHerblain = isHerblainX;
                
                // Generate sets with color coding based on ST HERBLAIN wins
                const sets = r.sets.map(s => {
                    const scoreA = s.equipe_a || s.score_a || 0;
                    const scoreX = s.equipe_x || s.score_x || 0;
                    
                    let setClass = 'set-score';
                    if (isJoueurAHerblain && scoreA > scoreX) {
                        setClass = 'set-score herblain-win';
                    } else if (isJoueurXHerblain && scoreX > scoreA) {
                        setClass = 'set-score herblain-win';
                    } else if ((isJoueurAHerblain && scoreA < scoreX) || (isJoueurXHerblain && scoreX < scoreA)) {
                        setClass = 'set-score herblain-lose';
                    }
                    
                    return `<span class="${setClass}">${scoreA}-${scoreX}</span>`;
                }).join('');
                
                // Determine if Herblain won this match
                let victoryClass = '';
                if (isHerblainA && matchScoreA > matchScoreX) {
                    victoryClass = 'victoire';
                } else if (isHerblainX && matchScoreX > matchScoreA) {
                    victoryClass = 'victoire';
                } else if ((isHerblainA && matchScoreA < matchScoreX) || (isHerblainX && matchScoreX < matchScoreA)) {
                    victoryClass = 'defaite';
                }
                
                return `
                    <div class="rencontre-item ${victoryClass}">
                        <div class="rencontre-num">${r.numero}</div>
                        <div class="rencontre-players">
                            ${joueurAName} <span class="vs">vs</span> ${joueurXName}
                        </div>
                        <div class="rencontre-sets">
                            ${sets}
                            <span class="rencontre-result">${result}</span>
                        </div>
                    </div>
                `;
            }).join('');
            
            modalBody.innerHTML = `
                <div class="teams-section">
                    <div class="team-panel">
                        <h3>${equipeA.nom || '√âquipe A'}</h3>
                        <ul class="player-list">${playersA}</ul>
                    </div>
                    <div class="team-panel">
                        <h3>${equipeX.nom || '√âquipe X'}</h3>
                        <ul class="player-list">${playersX}</ul>
                    </div>
                </div>
                <div class="chart-container">
                    <h3>üìä R√©partition des rencontres individuelles</h3>
                    <div class="modal-chart-wrapper">
                        <canvas id="modal-chart"></canvas>
                    </div>
                </div>
                <div class="rencontres-section">
                    <h3>Rencontres individuelles (${match.rencontres.length})</h3>
                    <div class="rencontre-grid">${rencontres}</div>
                </div>
            `;
            
            // Cr√©er le graphique pour cette rencontre
            createMatchChart(match, isHerblainA, isHerblainX);
            
            modal.classList.add('active');
        }
        
        function createMatchChart(match, isHerblainA, isHerblainX) {
            const canvas = document.getElementById('modal-chart');
            if (!canvas) return;
            
            // D√©truire l'ancien graphique s'il existe
            if (window.matchChart) {
                window.matchChart.destroy();
            }
            
            // Compter les victoires et d√©faites par nombre de sets jou√©s
            const stats = {
                sets3: { wins: 0, losses: 0 },
                sets4: { wins: 0, losses: 0 },
                sets5: { wins: 0, losses: 0 }
            };
            
            match.rencontres.forEach(r => {
                let setsWonA = 0, setsWonX = 0;
                if (r.sets && Array.isArray(r.sets)) {
                    r.sets.forEach(s => {
                        const scoreA = s.equipe_a || s.score_a || 0;
                        const scoreX = s.equipe_x || s.score_x || 0;
                        if (scoreA > scoreX) setsWonA++;
                        else if (scoreX > scoreA) setsWonX++;
                    });
                }
                
                const totalSets = setsWonA + setsWonX;
                let herblainWon = false;
                
                if (isHerblainA) {
                    herblainWon = setsWonA > setsWonX;
                } else if (isHerblainX) {
                    herblainWon = setsWonX > setsWonA;
                } else {
                    return;
                }
                
                if (totalSets === 3) {
                    if (herblainWon) stats.sets3.wins++;
                    else stats.sets3.losses++;
                } else if (totalSets === 4) {
                    if (herblainWon) stats.sets4.wins++;
                    else stats.sets4.losses++;
                } else if (totalSets === 5) {
                    if (herblainWon) stats.sets5.wins++;
                    else stats.sets5.losses++;
                }
            });
            
            const calcPercentage = (wins, losses) => {
                const total = wins + losses;
                return total > 0 ? ((wins / total) * 100).toFixed(1) : 0;
            };
            
            window.matchChart = new Chart(canvas, {
                type: 'bar',
                data: {
                    labels: ['3 sets', '4 sets', '5 sets'],
                    datasets: [
                        {
                            label: 'Victoires',
                            data: [stats.sets3.wins, stats.sets4.wins, stats.sets5.wins],
                            backgroundColor: '#4CAF50',
                            borderColor: '#2e7d32',
                            borderWidth: 2
                        },
                        {
                            label: 'D√©faites',
                            data: [stats.sets3.losses, stats.sets4.losses, stats.sets5.losses],
                            backgroundColor: '#f44336',
                            borderColor: '#c62828',
                            borderWidth: 2
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    scales: {
                        x: {
                            stacked: false,
                            grid: {
                                display: false
                            },
                            ticks: {
                                font: {
                                    size: 12,
                                    weight: 'bold'
                                }
                            }
                        },
                        y: {
                            beginAtZero: true,
                            ticks: {
                                stepSize: 1,
                                font: {
                                    size: 11
                                }
                            },
                            grid: {
                                color: 'rgba(0, 0, 0, 0.05)'
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            position: 'top',
                            labels: {
                                padding: 15,
                                font: {
                                    size: 12,
                                    weight: 'bold'
                                },
                                usePointStyle: true,
                                pointStyle: 'rectRounded'
                            }
                        },
                        tooltip: {
                            callbacks: {
                                afterLabel: function(context) {
                                    const dataIndex = context.dataIndex;
                                    let wins, losses, percentage;
                                    
                                    if (dataIndex === 0) {
                                        wins = stats.sets3.wins;
                                        losses = stats.sets3.losses;
                                    } else if (dataIndex === 1) {
                                        wins = stats.sets4.wins;
                                        losses = stats.sets4.losses;
                                    } else {
                                        wins = stats.sets5.wins;
                                        losses = stats.sets5.losses;
                                    }
                                    
                                    percentage = calcPercentage(wins, losses);
                                    const total = wins + losses;
                                    
                                    return [
                                        `Total: ${total} rencontres`,
                                        `Taux de victoire: ${percentage}%`
                                    ];
                                }
                            }
                        }
                    }
                }
            });
        }
        
        function closeModal() {
            document.getElementById('matchModal').classList.remove('active');
        }
        
        // Close modal on outside click
        window.onclick = function(event) {
            const modal = document.getElementById('matchModal');
            if (event.target === modal) {
                closeModal();
            }
        }
        
        // Load data on page load
        loadData();
    </script>
</body>
</html>
